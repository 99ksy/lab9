name: CMake

on:
 push:
   tags:
     - v**

jobs:

  build_packages:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install go
      run: sudo snap install go --classic
    
    - name: Install github-release
      run: |
        go install github.com/aktau/github-release@latest
        alias github-release=`go env GOPATH`/bin/github-release
      
    - name: Build package
      run: |
        cmake -H. -B_build -DCPACK_GENERATOR="TGZ"
        cmake --build _build --target package
      
    - name: File name
      run: export PACKAGE_FILENAME=print-`uname -s`-`uname -m`.tar.gz
      
    - name: Run github-release
      run: `go env GOPATH`/bin/github-release release \
        --user ${GITHUB_USERNAME} \
        --repo lab9 \
        --tag ${GITHUB_REF_NAME} \
        --name "libprint" \
        --description ${GITHUB_REF_NAME}
    
    - name: Add file to release
      run: `go env GOPATH`/bin/github-release upload \
        --user ${GITHUB_USERNAME} \
        --repo lab9 \
        --tag ${GITHUB_REF_NAME} \
        --name "${PACKAGE_FILENAME}" \
        --file _build/*.tar.gz

